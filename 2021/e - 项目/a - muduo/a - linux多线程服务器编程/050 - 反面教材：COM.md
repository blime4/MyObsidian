在C++中以[[虚函数]]作为接口基本上就跟二进制兼容性说“bye-bye”了。

具体地说，以只包含虚函数的class（称为interface class）作为程序库的接口，这样的接口是僵硬的，==一旦发布，无法修改。==
另外，Windows下，Visual C++编译的时候要选择Release或Debug模式，而且Debug模式编译出来的library通常不能在Release binary中使用（反之亦然），这也是因为两种模式下的[[CRT二进制不兼容]]（主要是内存分配方面，Debug有自己的簿记（bookkeeping））。Linux就没有这个麻烦，可以混用。

[[051 - 虚函数的缺点]]
[[052 - 二进制兼容性]]

## 解决办法

### 采用[[静态链接]]

这里的静态链接不是指使用静态库，而是指完全从源码编译出可执行文件。
在分布式系统里，采用静态链接也带来部署上的好处，只要把可执行文件放到机器上就能运行，不用考虑它依赖的 libraries。目前 muduo 就是采用静态链接。

---

### 通过[[动态库]]的版本管理来控制兼容性

这需要非常小心地检查每次改动的二进制兼容性并做好发布计划，比如 1.0. X 版本系列之间做到二进制兼容，1.1. X 版本系列之间做到二进制兼容，而 1.0. X 和 1.1. X 不必二进制兼容。
> 可以有意的把头文件和 class 区分用户可见和用户不可见两部分，在升级的时候，只需要注意用户可见部分的二进制兼容性，对用户不可见部分，升级时不必在意。

---

### 用 [[Pimpl]] 技法，编译器防火墙

在头文件中只暴露 non-virtual 接口，并且 class 的大小固定为 sizeof (Impl*)，这样可以随意更新库文件而不影响可执行文件。当然，这么做又多了一道间接性，可能有一定的性能损失。

[[051 - 虚函数的缺点]]
[[053 - inline函数]]