# TIME_WAIT

等待一段长为2MSL（Maximum Segment Life，报文段最大生存时间）的时间，才能完全关闭。

应该尽可能在服务器端避免TIME_WAIT状态。如果服务器端主动断开连接（先于client调用close），服务器就会进入TIME_WAIT状态。

协议设计上应该让客户端主动断开连接，这样就把TIME_WAIT状态分散到大量的客户端，如果客户端不活跃了，一些（恶意的）客户端不断开连接，这样就会占用服务器的连接资源，所以服务器端也需要有一种机制来踢掉不活跃的连接。

![[Pasted image 20211229175640.png]]


# TIME_WAIT状态存在的原因有两点：
❑可靠地终止TCP连接。
❑保证让迟来的TCP报文段有足够的时间被识别并丢弃。


在Linux系统上，一个TCP端口不能被同时打开多次（两次及以上）。当一个TCP连接处于TIME_WAIT状态时，我们将无法立即使用该连接占用着的端口来建立一个新连接。

反过来思考，如果不存在TIME_WAIT状态，则应用程序能够立即建立一个和刚关闭的连接相似的连接（这里说的相似，是指它们具有相同的IP地址和端口号）。这个新的、和原来相似的连接被称为原来的连接的化身（incarnation）。新的化身可能接收到属于原来的连接的、携带应用程序数据的TCP报文段（迟到的报文段），这显然是不应该发生的。这就是TIME_WAIT状态存在的第二个原因。