# 052 - 避免使用虚函数作为库的接口


总结：
> 如果我们要对以虚函数作为接口的类中，增加类的虚函数，但是由于调用虚函数是通过 `offset` 来查 vtable 表的，增加虚函数必然会改变虚函数表的位置，这样就不符合 [[052 - 二进制兼容性]], 这造成了脆弱性。



可能的解决方案，但是都是不可取的，最好就是避免使用虚函数作为库的接口。

方案一：

将所有新增的虚函数，放最类的最后，这样就不会影响到当前的 [[052 - 二进制兼容性]]
但是，会影响到其他继承于该类的 vtable 的 offset, 于事无补。

方案二：

通过链式继承来扩展现有的 interface，例如从 Graphics 派生出 Graphics2。
> 就是 [[050 - 反面教材：COM]] 的做法，这样会有一堆带版本号的函数，后续维护堪忧。

方案三：
略


真实例子：Linux Kernel

> Linuxkernel 从 0.01 的 67 个系统调用 8 发展到 2.6.37 的 340 个系统调用 9，kernel interface 一直在扩充，而且保持良好的兼容性，它保持兼容性的办法很土，就是给每个 system call 赋予一个终身不变的数字代号，等于把虚函数表的排列固定下来。
> 
> Linux 系统调用的编号以编译期常数方式固定下来，万年不变，轻而易举地解决了这个问题。





